  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Baby Sound Translator</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <!-- Meyda for audio features -->
  <script src="https://unpkg.com/meyda/dist/web/meyda.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; transition: background-color 0.3s, color 0.3s; color: #000; padding: 20px; min-height: 100vh; }
    .dark-mode { background-color: #333; color: #fff; }
    .container { max-width: 800px; margin: 0 auto; text-align: center; }
    button { padding: 10px 16px; font-size: 16px; margin: 6px; cursor: pointer; border-radius: 8px; border: none; }
    .mode-btn { background-color: #008cba; color: white; }
    .train-btn { background-color: #f0ad4e; color: white; }
    .export-btn { background-color: #4CAF50; color: white; }
    .input-box { margin-top: 16px; }
    input[type="text"] { padding: 10px; font-size: 16px; width: 80%; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; }
    .recording-status { font-size: 18px; color: #f0ad4e; margin-top: 8px; }
    #translation { margin-top: 16px; font-size: 1.5em; font-weight: bold; }
    .row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .small { opacity: 0.8; font-size: 0.9em; }
    .card { background: white; border-radius: 16px; padding: 16px; margin-top: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .dark-mode .card { background: #444; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Baby Sound Translator</h1>

    <!-- Theme Toggle -->
    <div class="row">
      <button class="mode-btn" onclick="toggleMode()">Toggle Dark/Light</button>
    </div>

    <!-- Recording Section -->
    <div class="card">
      <h2>Record & Label</h2>
      <div class="row">
        <button class="train-btn" id="startRecordingBtn" onclick="startRecording()">Start Recording</button>
        <button class="train-btn" id="stopRecordingBtn" onclick="stopRecording()" disabled>Stop Recording</button>
        <button class="train-btn" id="playRecordingBtn" onclick="playRecording()" disabled>Play Recording</button>
      </div>
      <div class="input-box">
        <input type="text" id="soundMeaning" placeholder="Enter the meaning (e.g., hungry, sleepy)" />
        <button class="train-btn" onclick="saveSound()">Save Sound</button>
      </div>
      <div class="row">
        <button class="export-btn" onclick="exportData()">Export Labeled Data (JSON)</button>
      </div>
      <div class="recording-status" id="recordingStatus">Recording status: Idle</div>
      <div class="small" id="datasetCount"></div>
    </div>

    <!-- Live Translation -->
    <div class="card">
      <h2>Live Translation</h2>
      <div id="translation">Waiting for sound...</div>
    </div>
  </div>

  <script>
    // ====== Basic Variables ======
    let isRecording = false;
    let soundData = JSON.parse(localStorage.getItem("soundData") || "[]");
    let audioContext, analyserNode, micSource, mediaRecorder, recordedChunks = [], currentRecording = null;
    let model, labels = [], meydaAnalyzer = null, listenTimer = null;

    updateDatasetCount();

    window.onload = async function() {
      // Theme from cookie
      const mode = getCookie("mode");
      if (mode) document.body.classList.toggle("dark-mode", mode === "dark");

      // Audio setup
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micSource = audioContext.createMediaStreamSource(stream);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 2048;
        micSource.connect(analyserNode);
        startMeyda();
      } catch(e){console.error(e); alert("Mic access denied or not supported.");}
    };

    // ====== Recording Functions ======
    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];
      mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        currentRecording = new Blob(recordedChunks,{type:"audio/webm"});
        document.getElementById("playRecordingBtn").disabled = !currentRecording;
      };
      mediaRecorder.start();
      isRecording = true;
      document.getElementById("startRecordingBtn").disabled = true;
      document.getElementById("stopRecordingBtn").disabled = false;
      document.getElementById("recordingStatus").innerText="Recording...";
    }

    function stopRecording() {
      if(mediaRecorder && isRecording){mediaRecorder.stop(); isRecording=false;}
      document.getElementById("startRecordingBtn").disabled=false;
      document.getElementById("stopRecordingBtn").disabled=true;
      document.getElementById("recordingStatus").innerText="Recording stopped. Enter meaning then save.";
    }

    function playRecording(){ if(!currentRecording) return alert("No recording."); new Audio(URL.createObjectURL(currentRecording)).play(); }

    function saveSound() {
      const meaning = document.getElementById("soundMeaning").value.trim();
      if(!meaning || !currentRecording){alert("Record and enter meaning."); return;}
      const reader = new FileReader();
      reader.onload = ()=>{ soundData.push({audio:reader.result,meaning}); localStorage.setItem("soundData",JSON.stringify(soundData)); updateDatasetCount(); alert("Saved!"); };
      reader.readAsDataURL(currentRecording);
      document.getElementById("soundMeaning").value=""; currentRecording=null;
      document.getElementById("playRecordingBtn").disabled=true;
    }

    function exportData() {
      if(!soundData.length) return alert("No data."); 
      const blob=new Blob([JSON.stringify(soundData,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='baby-sound-data.json'; a.click();
    }

    function updateDatasetCount(){ document.getElementById("datasetCount").innerText=`Samples saved: ${soundData.length}`; }

    // ====== Live Features ======
    function startMeyda() {
      if(!window.Meyda) return;
      meydaAnalyzer = Meyda.createMeydaAnalyzer({
        audioContext,
        source: micSource,
        bufferSize:2048,
        featureExtractors:["mfcc"],
        callback:()=>{}
      });
      meydaAnalyzer.start();
      listenTimer=setInterval(liveClassifyTick,200);
    }

    async function liveClassifyTick() {
      if(!meydaAnalyzer || !model || !labels.length) return;
      const mfcc = meydaAnalyzer.get("mfcc");
      if(!mfcc) return;
      const input = tf.tensor([mfcc.slice(0,13)]);
      const pred = model.predict(input);
      const probs = await pred.data(); input.dispose(); pred.dispose();
      let bestIdx=0,bestVal=-Infinity;
      for(let i=0;i<probs.length;i++){if(probs[i]>bestVal){bestVal=probs[i];bestIdx=i;}}
      document.getElementById("translation").innerText=`Translation: ${labels[bestIdx]} (${(bestVal*100).toFixed(1)}%)`;
    }

    // ====== Theme & Cookies ======
    function toggleMode(){ document.body.classList.toggle("dark-mode"); setCookie("mode",document.body.classList.contains("dark-mode")?"dark":"light",365); }
    function setCookie(name,value,days){const e=new Date(Date.now()+days*864e5).toUTCString(); document.cookie=`${name}=${value};expires=${e};path=/`; }
    function getCookie(name){const n=name+"=";return document.cookie.split(';').map(c=>c.trim()).find(c=>c.indexOf(n)===0)?.substring(n.length) || null; }

  </script>

  <!-- ====== TensorFlow.js Model Loader ====== -->
  <script>
    async function loadModel() {
      try {
        // Use relative path if model folder is in same repo
        const modelURL = "model/model.json";
        model = await tf.loadLayersModel(modelURL);
        // Load labels.json
        labels = await fetch("model/labels.json").then(r=>r.json());
        console.log("âœ… Model loaded successfully!");
      } catch(e){console.error("Model load error:",e); alert("Failed to load model.");}
    }

    // Load model on page load
    window.onload = loadModel;
  </script>

</body>
</html>
